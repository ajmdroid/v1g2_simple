name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to build from'
        required: false
        default: 'dev'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install PlatformIO and esptool
        run: pip install platformio esptool
      
      - name: Build and deploy web interface
        run: |
          cd interface
          npm ci
          npm run deploy
          cd ..
      
      - name: Build firmware
        run: pio run -e waveshare-349
      
      - name: Build filesystem
        run: pio run -e waveshare-349 -t buildfs
      
      - name: Prepare release artifacts
        run: |
          mkdir -p release
          cp .pio/build/waveshare-349/bootloader.bin release/
          cp .pio/build/waveshare-349/partitions.bin release/
          cp ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin release/
          cp .pio/build/waveshare-349/firmware.bin release/
          cp .pio/build/waveshare-349/littlefs.bin release/
          
          # Create merged firmware for web installer
          esptool --chip esp32s3 merge-bin \
            -o release/merged-firmware.bin \
            --flash-mode dio \
            --flash-freq 80m \
            --flash-size 16MB \
            0x0000 release/bootloader.bin \
            0x8000 release/partitions.bin \
            0xe000 release/boot_app0.bin \
            0x10000 release/firmware.bin \
            0xc90000 release/littlefs.bin
          
          # Update manifest with correct version (handle tags vs manual triggers)
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev"
          fi
          sed -i "s|\"version\": \".*\"|\"version\": \"$VERSION\"|" docs/install/manifest.json
          cp docs/install/manifest.json release/
      
      - name: Upload artifacts to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/merged-firmware.bin
            release/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update web installer
        run: |
          # Copy binaries to docs/install for GitHub Pages
          cp release/*.bin docs/install/
          cp release/manifest.json docs/install/
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/install
          destination_dir: install
