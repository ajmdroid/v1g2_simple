name: Build Firmware & Web Interface

on:
  # Manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
  
  # Auto-trigger on push to main/master/dev
  push:
    branches:
      - main
      - master
      - dev
    paths:
      - 'src/**'
      - 'include/**'
      - 'interface/**'
      - 'platformio.ini'
      - '.github/workflows/build.yml'
  
  # Auto-trigger on pull requests
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: interface/package-lock.json
    
    - name: ğŸ“¦ Install web dependencies
      working-directory: interface
      run: npm ci
    
    - name: ğŸ¨ Build Svelte web interface
      working-directory: interface
      run: |
        npm run build
        echo "âœ… Web interface built successfully"
    
    - name: ğŸ“ Deploy web files to data/ folder
      working-directory: interface
      run: |
        npm run deploy
        echo "âœ… Web files deployed to data/"
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
    
    - name: ğŸ”§ Install PlatformIO
      run: |
        pip install --upgrade platformio
        pio --version
    
    - name: ğŸ—ï¸ Build firmware (Mac/Linux)
      run: |
        pio run -e waveshare-349
        echo "âœ… Mac/Linux firmware built successfully"
    
    - name: ğŸ—ï¸ Build firmware (Windows)
      run: |
        pio run -e waveshare-349-windows
        echo "âœ… Windows firmware built successfully"
    
    - name: ğŸ“Š Check build size
      run: |
        echo "### Build Size Report" >> $GITHUB_STEP_SUMMARY
        echo "#### Mac/Linux (waveshare-349)" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        pio run -e waveshare-349 -t size >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "#### Windows (waveshare-349-windows)" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        pio run -e waveshare-349-windows -t size >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ“¦ Prepare artifacts
      run: |
        mkdir -p artifacts/mac-linux artifacts/windows
        
        # Mac/Linux build
        cp .pio/build/waveshare-349/firmware.bin artifacts/mac-linux/
        cp .pio/build/waveshare-349/bootloader.bin artifacts/mac-linux/
        cp .pio/build/waveshare-349/partitions.bin artifacts/mac-linux/
        if [ -f .pio/build/waveshare-349/littlefs.bin ]; then
          cp .pio/build/waveshare-349/littlefs.bin artifacts/mac-linux/
        fi
        
        # Windows build  
        cp .pio/build/waveshare-349-windows/firmware.bin artifacts/windows/
        cp .pio/build/waveshare-349-windows/bootloader.bin artifacts/windows/
        cp .pio/build/waveshare-349-windows/partitions.bin artifacts/windows/
        if [ -f .pio/build/waveshare-349-windows/littlefs.bin ]; then
          cp .pio/build/waveshare-349-windows/littlefs.bin artifacts/windows/
        fi
        
        # Create version info
        echo "Build Date: $(date)" > artifacts/BUILD_INFO.txt
        echo "Commit: ${{ github.sha }}" >> artifacts/BUILD_INFO.txt
        echo "Branch: ${{ github.ref_name }}" >> artifacts/BUILD_INFO.txt
        echo "Triggered by: ${{ github.event_name }}" >> artifacts/BUILD_INFO.txt
        
        ls -lhR artifacts/
    
    - name: ğŸ“¤ Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.sha }}
        path: artifacts/
        retention-days: 30
    
    - name: ğŸ“ Create release notes
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "## ğŸ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- \`firmware.bin\` - Main firmware binary" >> $GITHUB_STEP_SUMMARY
        echo "- \`bootloader.bin\` - ESP32-S3 bootloader" >> $GITHUB_STEP_SUMMARY
        echo "- \`partitions.bin\` - Partition table" >> $GITHUB_STEP_SUMMARY
        echo "- \`littlefs.bin\` - Filesystem with web interface" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ Flash Instructions" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Download artifacts, then:" >> $GITHUB_STEP_SUMMARY
        echo "esptool.py --chip esp32s3 --port /dev/ttyUSB0 write_flash \\" >> $GITHUB_STEP_SUMMARY
        echo "  0x0000 bootloader.bin \\" >> $GITHUB_STEP_SUMMARY
        echo "  0x8000 partitions.bin \\" >> $GITHUB_STEP_SUMMARY
        echo "  0x10000 firmware.bin \\" >> $GITHUB_STEP_SUMMARY
        echo "  0x3D0000 littlefs.bin" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Or use PlatformIO:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "pio run -t upload" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Test build.sh on actual Windows
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: interface/package-lock.json
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install PlatformIO
      run: pip install --upgrade platformio
    
    - name: ğŸªŸ Test build.sh on Windows (full build)
      shell: bash
      run: |
        chmod +x build.sh
        ./build.sh
        echo "âœ… Windows build.sh completed successfully"

  # Optional: Create a release when tagged
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: firmware-${{ github.sha }}
        path: artifacts/
    
    - name: ğŸ“¦ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/firmware.bin
          artifacts/bootloader.bin
          artifacts/partitions.bin
          artifacts/littlefs.bin
          artifacts/BUILD_INFO.txt
        draft: false
        prerelease: false
        generate_release_notes: true
